<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-fullscreen">
    <title>Cargun Ship Controller</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #000000;
            color: white;
        }

        /* ì „ì²´í™”ë©´ ì•„ë‹ ë•Œ ëª¨ë“  UI ìˆ¨ê¹€ */
        body:not(.fullscreen-active) #preparePhase,
        body:not(.fullscreen-active) #battlePhase {
            display: none !important;
        }

        /* ì „ì²´í™”ë©´ì¼ ë•Œ ì „ì²´í™”ë©´ ë²„íŠ¼ ìˆ¨ê¹€ */
        body.fullscreen-active #fullscreenPrompt {
            display: none !important;
        }

        /* ì „ì²´í™”ë©´ ì•ˆë‚´ í™”ë©´ */
        #fullscreenPrompt {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            text-align: center;
            padding: 20px;
        }

        #fullscreenPrompt h1 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        #fullscreenPrompt p {
            font-size: 1.2em;
            margin-bottom: 30px;
            opacity: 0.8;
        }

        #fullscreenPrompt button {
            padding: 20px 40px;
            font-size: 1.5em;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        #fullscreenPrompt button:active {
            background: #45a049;
            transform: scale(0.95);
        }

        /* ì„¸ë¡œ í™”ë©´ì¼ ë•Œ íšŒì „ ë©”ì‹œì§€ í‘œì‹œ (ì „ì²´í™”ë©´ ìƒíƒœì—ì„œë§Œ) */
        @media screen and (orientation: portrait) {
            body.fullscreen-active::before {
                content: "ğŸ“± í™”ë©´ì„ ê°€ë¡œë¡œ ëŒë ¤ì£¼ì„¸ìš”";
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 1.5em;
                text-align: center;
                z-index: 9999;
                background: rgba(0,0,0,0.9);
                padding: 30px;
                border-radius: 15px;
                width: 80%;
            }
            
            body.fullscreen-active #preparePhase,
            body.fullscreen-active #battlePhase {
                display: none !important;
            }
        }

        /* ì¤€ë¹„ í˜ì´ì¦ˆ - ìƒˆ UI */
        #preparePhase {
            display: none;
            flex-direction: column;
            height: 100vh;
            height: 100lvh; /* iOS Safariìš© */
            width: 100vw;
            width: 100lvw; /* iOS Safariìš© */
            padding: 10px;
            justify-content: center;
        }

        /* í”Œë ˆì´ì–´ ì •ë³´ í—¤ë” */
        .player-header {
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .player-header .color-indicator {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid white;
        }

        /* ëŒ€ê¸° ë©”ì‹œì§€ */
        .waiting-message {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            font-size: 1.2em;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 20px;
        }

        /* ì „íˆ¬ í˜ì´ì¦ˆ */
        #battlePhase {
            display: none;
            height: 100vh;
            height: 100lvh; /* iOS Safariìš© */
            width: 100vw;
            width: 100lvw; /* iOS Safariìš© */
            position: relative;
            -webkit-transform: translateZ(0); /* iOS Safari GPU ê°€ì† */
            transform: translateZ(0);
        }

        #battlePhase .player-info {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.3em;
            font-weight: bold;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 10px;
        }

        #battlePhase .color-indicator {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .joystick-container {
            position: absolute;
            bottom: 40px;
            left: 40px;
            width: 180px;
            height: 180px;
            z-index: 100; /* iOS Safari ê°€ì‹œì„± ë³´ì¥ */
            -webkit-transform: translate3d(0, 0, 0); /* iOS Safari GPU ê°€ì† */
            transform: translate3d(0, 0, 0);
        }

        #joystickBase {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.3); /* ë°ì€ ë°˜íˆ¬ëª… */
            border: 4px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            position: relative;
            -webkit-transform: translateZ(0); /* iOS Safari GPU ê°€ì† */
            transform: translateZ(0);
        }

        #joystickStick {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.9); /* ë°ì€ í°ìƒ‰ */
            border: 2px solid rgba(255, 255, 255, 1);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            -webkit-transform: translate(-50%, -50%) translateZ(0); /* iOS Safari GPU ê°€ì† */
        }

        .switch-turret-btn {
            position: absolute;
            bottom: 40px;
            right: 40px;
            width: 180px;
            height: 180px;
            background: #9C27B0;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100; /* iOS Safari ê°€ì‹œì„± ë³´ì¥ */
            -webkit-transform: translateZ(0); /* iOS Safari GPU ê°€ì† */
            transform: translateZ(0);
        }

        .switch-turret-btn:active {
            background: #7B1FA2;
            transform: scale(0.95);
        }

        /* ìƒ‰ìƒ ì •ì˜ */
        .color-green { background: #4CAF50; }
        .color-blue { background: #2196F3; }
        .color-purple { background: #9C27B0; }
        .color-orange { background: #FF9800; }
    </style>
</head>
<body>
    <!-- ì „ì²´í™”ë©´ ì•ˆë‚´ -->
    <div id="fullscreenPrompt">
        <h1>ğŸš€ Cargun Ship Controller</h1>
        <p>ì „ì²´í™”ë©´ ëª¨ë“œë¡œ ì‹œì‘í•˜ì„¸ìš”</p>
        <button onclick="enterFullscreen()">ì‹œì‘í•˜ê¸°</button>
    </div>

    <!-- ì¤€ë¹„ í˜ì´ì¦ˆ -->
    <div id="preparePhase">
        <div class="player-header">
            <span>Player:</span>
            <div class="color-indicator" id="playerColorIndicator"></div>
            <span id="playerColorText">-</span>
        </div>

        <!-- ëŒ€ê¸° ë©”ì‹œì§€ -->
        <div class="waiting-message">
            Waiting for battle to start...
        </div>
    </div>

    <!-- ì „íˆ¬ í˜ì´ì¦ˆ -->
    <div id="battlePhase">
        <div class="player-info">
            <div class="color-indicator" id="battleColorIndicator"></div>
            <span id="battlePlayerText">-</span>
        </div>
        
        <div class="joystick-container">
            <div id="joystickBase">
                <div id="joystickStick"></div>
            </div>
        </div>
        
        <button class="switch-turret-btn" onclick="switchTurret()">SWITCH<br>TURRET</button>
    </div>

    <script>
        const socket = io();
        
        let playerData = null;
        let currentTurret = 'A';
        let gamePhase = 'prepare';
        let joystickActive = false;
        let joystickTouchId = null;
        let joystickAngle = 0;

        // ì „ì²´í™”ë©´ ì§„ì…
        function enterFullscreen() {
            const elem = document.documentElement;
            
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
            
            // iOS Safari ëŒ€ì‘
            if (typeof screen !== 'undefined' && screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(() => {});
            }
            
            document.body.classList.add('fullscreen-active');
            
            // ìë™ ì ‘ì† ì‹œë„
            connectToServer();
        }

        // ì „ì²´í™”ë©´ í•´ì œ ê°ì§€
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                console.log('âš ï¸ ì „ì²´í™”ë©´ ì¢…ë£Œ - ì—°ê²° í•´ì œ');
                disconnectAndReset();
            }
        });

        document.addEventListener('webkitfullscreenchange', () => {
            if (!document.webkitFullscreenElement) {
                console.log('âš ï¸ ì „ì²´í™”ë©´ ì¢…ë£Œ (webkit) - ì—°ê²° í•´ì œ');
                disconnectAndReset();
            }
        });

        // âœ… í˜ì´ì§€ê°€ ë°±ê·¸ë¼ìš´ë“œë¡œ ê°€ë©´ ì¦‰ì‹œ ì—°ê²° í•´ì œ ë° ì´ˆê¸°í™”
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                console.log('âš ï¸ í˜ì´ì§€ê°€ ë°±ê·¸ë¼ìš´ë“œë¡œ ì´ë™ - ì—°ê²° í•´ì œ');
                disconnectAndReset();
            }
        });

        // âœ… í˜ì´ì§€ ì´ë™/ì¢…ë£Œ ê°ì§€ (ë’¤ë¡œê°€ê¸°, ìƒˆë¡œê³ ì¹¨, ì°½ ë‹«ê¸° ë“±)
        window.addEventListener('beforeunload', (event) => {
            console.log('âš ï¸ beforeunload ì´ë²¤íŠ¸ - ì—°ê²° í•´ì œ');
            disconnectAndReset();
        });

        // âœ… iOS Safari ì¶”ê°€ ëŒ€ì‘ (pagehide)
        window.addEventListener('pagehide', (event) => {
            console.log('âš ï¸ pagehide ì´ë²¤íŠ¸ - ì—°ê²° í•´ì œ');
            disconnectAndReset();
        });

        // âœ… ì•± ì „í™˜ ê°ì§€ (blur)
        window.addEventListener('blur', () => {
            console.log('âš ï¸ ì°½ í¬ì»¤ìŠ¤ ìƒìŒ - ì—°ê²° í•´ì œ');
            disconnectAndReset();
        });

        // ì—°ê²° í•´ì œ ë° ë¦¬ì…‹ í†µí•© í•¨ìˆ˜
        function disconnectAndReset() {
            // ì†Œì¼“ ì—°ê²° ê°•ì œ ì¢…ë£Œ
            if (socket && socket.connected) {
                // âœ… ì„œë²„ì— ëª…ì‹œì ìœ¼ë¡œ ê°•ì œ ì—°ê²° í•´ì œ ìš”ì²­
                socket.emit('forceDisconnect');
                socket.disconnect();
            }
            
            // ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ë¦¬ì…‹
            resetToInitialState();
        }

        // ì´ˆê¸° ìƒíƒœë¡œ ë¦¬ì…‹í•˜ëŠ” í•¨ìˆ˜
        function resetToInitialState() {
            // í”Œë ˆì´ì–´ ë°ì´í„° ì´ˆê¸°í™”
            playerData = null;
            currentTurret = 'A';
            gamePhase = 'prepare';
            joystickActive = false;
            joystickTouchId = null;
            joystickAngle = 0;
            
            // UI ì´ˆê¸°í™”
            document.getElementById('preparePhase').style.display = 'none';
            document.getElementById('battlePhase').style.display = 'none';
            document.body.classList.remove('fullscreen-active');
            
            // ì „ì²´í™”ë©´ ì¢…ë£Œ
            if (document.fullscreenElement) {
                document.exitFullscreen().catch(() => {});
            }
            
            // ì „ì²´í™”ë©´ í”„ë¡¬í”„íŠ¸ ë‹¤ì‹œ í‘œì‹œ
            document.getElementById('fullscreenPrompt').style.display = 'flex';
            
            console.log('ğŸ”„ ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ë¦¬ì…‹ ì™„ë£Œ');
        }

        // ì„œë²„ ìë™ ì ‘ì†
        function connectToServer() {
            // âœ… ì†Œì¼“ì´ ëŠì–´ì§„ ìƒíƒœë©´ ë¨¼ì € ì¬ì—°ê²°
            if (!socket.connected) {
                console.log('ğŸ”Œ ì†Œì¼“ ì¬ì—°ê²° ì‹œë„...');
                socket.connect();
                
                // ì—°ê²° ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸° í›„ join
                socket.once('connect', () => {
                    console.log('âœ… ì†Œì¼“ ì¬ì—°ê²° ì„±ê³µ');
                    socket.emit('join', { nickname: 'Player' });
                });
            } else {
                // ì´ë¯¸ ì—°ê²°ëœ ê²½ìš° ë°”ë¡œ join
                socket.emit('join', { nickname: 'Player' });
            }
        }

        // ì ‘ì† ì„±ê³µ
        socket.on('joined', (data) => {
            playerData = data;
            currentTurret = data.turret;
            
            console.log('ì ‘ì† ì„±ê³µ:', data);
            
            // ìƒ‰ìƒ ì—…ë°ì´íŠ¸
            updatePlayerColor(data.color, data.slot);
            
            // ì¤€ë¹„ í˜ì´ì¦ˆ í‘œì‹œ
            document.getElementById('preparePhase').style.display = 'flex';
        });

        // ë°©ì´ ê½‰ ì°¼ì„ ë•Œ
        socket.on('roomFull', (message) => {
            alert(message);
            document.body.classList.remove('fullscreen-active');
            document.exitFullscreen();
        });

        // í”Œë ˆì´ì–´ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
        function updatePlayerColor(color, slot) {
            const colorClass = `color-${color}`;
            const playerText = `Player ${slot} (${color.toUpperCase()})`;
            
            // ì¤€ë¹„ í˜ì´ì¦ˆ ìƒ‰ìƒ
            const colorIndicator = document.getElementById('playerColorIndicator');
            colorIndicator.className = `color-indicator ${colorClass}`;
            document.getElementById('playerColorText').textContent = color.toUpperCase();
            
            // ì „íˆ¬ í˜ì´ì¦ˆ ìƒ‰ìƒ
            const battleColorIndicator = document.getElementById('battleColorIndicator');
            battleColorIndicator.className = `color-indicator ${colorClass}`;
            document.getElementById('battlePlayerText').textContent = playerText;
        }

        // Phase ë³€ê²½
        socket.on('phaseChange', (phase) => {
            console.log('Phase ë³€ê²½:', phase);
            gamePhase = phase;
            
            if (phase === 'prepare') {
                document.getElementById('battlePhase').style.display = 'none';
                document.getElementById('preparePhase').style.display = 'flex';
            } else if (phase === 'battle') {
                document.getElementById('preparePhase').style.display = 'none';
                document.getElementById('battlePhase').style.display = 'block';
                initJoystick();
            }
        });

        // í„°ë › ì „í™˜
        function switchTurret() {
            console.log('í„°ë › ì „í™˜ ìš”ì²­');
            socket.emit('switchTurret');
        }

        socket.on('turretSwitched', (newTurret) => {
            console.log('í„°ë › ì „í™˜ ì„±ê³µ:', newTurret);
            currentTurret = newTurret;
        });

        // ì¡°ì´ìŠ¤í‹± ì´ˆê¸°í™”
        function initJoystick() {
            const base = document.getElementById('joystickBase');
            const stick = document.getElementById('joystickStick');

            base.addEventListener('touchstart', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (joystickTouchId === null && e.touches.length > 0) {
                    joystickTouchId = e.touches[0].identifier;
                    joystickActive = true;
                    updateJoystick(e.touches[0]);
                    
                    // âœ… ë°œì‚¬ ìƒíƒœ true ì „ì†¡
                    socket.emit('shootStatus', { shooting: true });
                    console.log('ë°œì‚¬ ì‹œì‘ â†’ ì„œë²„ ì „ì†¡');
                }
            }, { passive: false });

            base.addEventListener('touchmove', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (joystickActive && joystickTouchId !== null) {
                    for (let i = 0; i < e.touches.length; i++) {
                        if (e.touches[i].identifier === joystickTouchId) {
                            updateJoystick(e.touches[i]);
                            break;
                        }
                    }
                }
            }, { passive: false });

            base.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                let touchEnded = true;
                for (let i = 0; i < e.touches.length; i++) {
                    if (e.touches[i].identifier === joystickTouchId) {
                        touchEnded = false;
                        break;
                    }
                }
                
                if (touchEnded) {
                    joystickActive = false;
                    joystickTouchId = null;
                    stick.style.transform = 'translate(-50%, -50%)';
                    joystickAngle = 0;
                    
                    // âœ… ë°œì‚¬ ìƒíƒœ false ì „ì†¡
                    socket.emit('shootStatus', { shooting: false });
                    console.log('ë°œì‚¬ ì¢…ë£Œ â†’ ì„œë²„ ì „ì†¡');
                }
            }, { passive: false });

            base.addEventListener('touchcancel', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                joystickActive = false;
                joystickTouchId = null;
                stick.style.transform = 'translate(-50%, -50%)';
                joystickAngle = 0;
                
                // âœ… ë°œì‚¬ ìƒíƒœ false ì „ì†¡
                socket.emit('shootStatus', { shooting: false });
                console.log('ë°œì‚¬ ì·¨ì†Œ â†’ ì„œë²„ ì „ì†¡');
            }, { passive: false });
        }

        function updateJoystick(touch) {
            const base = document.getElementById('joystickBase');
            const stick = document.getElementById('joystickStick');
            
            const rect = base.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            let deltaX = touch.clientX - centerX;
            let deltaY = touch.clientY - centerY;
            
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            const maxDistance = 50;
            
            if (distance > maxDistance) {
                deltaX = (deltaX / distance) * maxDistance;
                deltaY = (deltaY / distance) * maxDistance;
            }
            
            stick.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;
            
            // âœ… ê°ë„ ê³„ì‚°: 12ì‹œ ë°©í–¥ = 0ë„, ì‹œê³„ë°©í–¥ ì¦ê°€
            // atan2(y, x)ëŠ” 3ì‹œ ë°©í–¥ì´ 0ë„ì´ë¯€ë¡œ, 12ì‹œ ë°©í–¥(ìœ„ìª½)ì„ 0ë„ë¡œ ë³€í™˜
            // 12ì‹œ = (0, -1) â†’ atan2(-1, 0) = -90ë„
            // ì¢Œí‘œê³„: ìœ„(-y), ì•„ë˜(+y), ì™¼ìª½(-x), ì˜¤ë¥¸ìª½(+x)
            let angle = Math.atan2(deltaX, -deltaY) * (180 / Math.PI);
            if (angle < 0) angle += 360; // ìŒìˆ˜ë¥¼ ì–‘ìˆ˜ë¡œ ë³€í™˜
            
            joystickAngle = angle;
            
            socket.emit('turretAngle', { angle: joystickAngle });
        }
    </script>
</body>
</html>